
local assetHelper = asset.require('util/asset_helper')
local sceneHelper = asset.require('util/scene_helper')
local propertyHelper = asset.require('util/property_helper')

-- Specifying which other assets should be loaded in this scene
asset.require('spice/base')

asset.require('scene/solarsystem/sun/sun')
asset.request('scene/solarsystem/planets/earth/earth')
asset.request('scene/solarsystem/planets/earth/atmosphere')
asset.request('scene/solarsystem/planets/earth/markers')
asset.request('scene/solarsystem/planets/earth/moon/moon')
asset.request('scene/solarsystem/planets/mars/mars')
asset.request('scene/solarsystem/planets/mars/atmosphere')
asset.request('scene/solarsystem/planets/venus/venus')
asset.request('scene/solarsystem/planets/venus/atmosphere')
asset.require('scene/digitaluniverse/milkyway')
asset.require('scene/digitaluniverse/stars')
--assetHelper.requestAll(asset, 'scene/digitaluniverse')


-- Load default key bindings applicable to most scenes
asset.require('util/default_keybindings')
asset.require('util/default_dashboard')
asset.require('util/default_joystick')

-- Load web gui
local webGui = asset.require('util/webgui')

asset.request('customization/globebrowsing')

-- Keybindings that are specific for this scene
local Keybindings = {
    {
        Key = "b",
        Name = "Toggle background",
        Command = propertyHelper.invert('Scene.MilkyWay.Renderable.Enabled') ..
                  propertyHelper.invert('Scene.Stars.Renderable.Enabled'),
        Documentation = "Toggle background (Stars and Milkyway).",
        GuiPath = "/Rendering",
        Local = false
    },
    {
        Key = "g",
        Name = "Toggle background/shading",
        Command = propertyHelper.invert('Scene.MilkyWay.Renderable.Enabled') ..
                  propertyHelper.invert('Scene.Stars.Renderable.Enabled') ..
                  propertyHelper.invert('Scene.Earth.Renderable.Layers.NightLayers.Earth_at_Night_2012.Enabled') ..
                  propertyHelper.invert('Scene.EarthAtmosphere.Renderable.Enabled') ..
                  propertyHelper.invert('Scene.MarsAtmosphere.Renderable.Enabled') ..
                  propertyHelper.invert('Scene.Earth.Renderable.Layers.WaterMasks.MODIS_Water_Mask.Enabled') ..
                  propertyHelper.invert('Scene.Moon.Renderable.Enabled') ..
                  propertyHelper.invert('Scene.Sun.Renderable.Enabled'),
        Documentation = "Toogles background and shading mode on the Earth and Mars alongside visibility of the Moon and the Sun",
        GuiPath = "/Rendering",
        Local = false
    },
    {
        Key = "h",
        Name="Toggle Trails",
        Command = "local list = openspace.getProperty('{planetTrail_solarSystem}.Renderable.Enabled'); for _,v in pairs(list) do openspace.setPropertyValueSingle(v, not openspace.getPropertyValue(v)) end\n" ..
        "local moonlist = openspace.getProperty('{moonTrail_solarSystem}.Renderable.Enabled'); for _,v in pairs(moonlist) do openspace.setPropertyValueSingle(v, not openspace.getPropertyValue(v)) end",
        Documentation = "Toggles the visibility of planet and moon trails",
        GuiPath = "/Rendering",
        Local = false
    },
    {
        Key = "l",
        Name = "Toggle planet labels",
        Command = "local list = openspace.getProperty('{solarsystem_labels}.Renderable.Enabled'); for _,v in pairs(list) do openspace.setPropertyValueSingle(v, not openspace.getPropertyValue(v)) end",
        Documentation = "Turns on visibility for all solar system labels",
        GuiPath = "/Rendering",
        Local = false
    },
    {
        Key = "r",
        Name = "Toggle Rendering Time Saving",
        Command = propertyHelper.invert('Dashboard.Framerate.EnableFPSRecording'),
        Documentation = "Toogles FPS Delta time saving",
        GuiPath = "/Rendering",
        Local = false
    },
    {
        Key = "m",
        Name = "Toggle Marks Saving",
        Command = propertyHelper.invert('Dashboard.Framerate.MarkPointInterest'),
        Documentation = "Toogles Marks saving",
        GuiPath = "/Rendering",
        Local = false
    }

}

asset.onInitialize(function ()
    webGui.setCefRoute("onscreen")

    sceneHelper.bindKeys(Keybindings)
    openspace.setDefaultGuiSorting()

    openspace.globebrowsing.loadWMSServersFromFile(
        openspace.absPath("${DATA}/globebrowsing_servers.lua")
    )
end)

asset.onDeinitialize(function ()
    sceneHelper.unbindKeys(Keybindings)
end)



local earthAsset = asset.require('scene/solarsystem/planets/earth/earth')
--asset.require('scene/solarsystem/planets/earth/satellites/satellites.asset')


asset.onInitialize(function ()
    local now = openspace.time.currentWallTime()
    -- Jump back one day to be able to show complete weather data on Earth.
    openspace.time.setTime(openspace.time.advancedTime(now, "-1d"))

    openspace.globebrowsing.goToGeo("Earth", 58.5877, 16.1924, 20000000)

    openspace.markInterestingNodes({ "Earth", "Mars", "Moon", "Sun" })

    --openspace.setPropertyValue("{earth_satellites}.Renderable.Enabled", false)
end)

asset.onDeinitialize(function ()
    openspace.removeInterestingNodes({ "Earth", "Mars", "Moon", "Sun" })
end)
